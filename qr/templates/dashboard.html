{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Canteen Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

  <style>
    body {
      background-color: #0b1c2c;
      color: white;
    }
    .sidebar {
      height: 100vh;
      background-color: #142b3f;
      padding: 20px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      margin: 15px 0;
    }
    .sidebar a:hover {
      text-decoration: underline;
    }
    .card {
      background-color: #ffffff;
      color: #000000;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .topbar {
      background-color: #142b3f;
      color: white;
      padding: 10px 20px;
    }
    .submenu {
      margin-left: 15px;
    }
    .submenu li a {
      font-size: 0.95rem;
      margin: 5px 0;
      color: #d1e7ff;
    }
    #manage-menu-items-box {
      background-color: #1e2a43;
      border-radius: 12px;
      padding: 15px;
      margin-top: 20px;
    }
    .menu-card {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
      color: #000;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar">
        <div class="mb-4">
          <img src="{% static 'images/semmon-removebg-preview.png' %}" alt="Logo" height="65" />
        </div>
        <a href="#">Dashboard</a>
        <a href="{% url 'qr:qrscanner' %}">QR Scanner</a>
        
        <!-- Menu Management Dropdown -->
        <li class="nav-item" style="list-style: none;">
          <a href="#" class="nav-link" onclick="toggleSubMenu('menu-management-submenu')">Menu Management</a>
          <ul class="submenu" id="menu-management-submenu" style="display: none; padding-left: 20px;">
            <li><a href="{% url 'qr:add_item' %}">‚ûï Add New Item</a></li>
            <li><a href="{% url 'qr:view_items' %}">üëÅÔ∏è View All Items</a></li>
            <li><a href="{% url 'qr:upload_menu' %}">‚¨ÜÔ∏è Upload Menu</a></li>
          </ul>
        </li>

        <!-- Settings Dropdown -->
        <li class="nav-item" style="list-style: none;">
          <a href="#" class="nav-link" onclick="toggleSubMenu('settings-submenu')">Settings</a>
          <ul class="submenu" id="settings-submenu" style="display: none; padding-left: 20px;">
            <li><a href="{% url 'qr:set_company' %}">üè¢ Set Company</a></li>
            <li><a href="{% url 'qr:set_department' %}">üè¨ Set Department</a></li>
          </ul>
        </li>
      </div>

      <!-- Main content -->
      <div class="col-md-10">
        <!-- Topbar -->
        <div class="topbar d-flex justify-content-between align-items-center">
          <div>
            <img src="{% static 'images/semmon-removebg-preview.png' %}" alt="Logo" height="45" />
          </div>
          <div>{{ current_date }}</div>
          <nav>
            {% if user.is_authenticated %}
              <a href="{% url 'qr:logout' %}">üö™ Logout</a>
            {% else %}
              <a href="{% url 'qr:login' %}">üîë Login</a>
            {% endif %}
          </nav>
        </div>

        <div class="container mt-4">
          <!-- Today Summary + Monthly Report -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card p-4">
                <h5>Today‚Äôs Summary</h5>
                <p>Total Users Served</p>
                <ul class="list-unstyled">
                  <li>Tea: {{ tea_count }} cups</li>
                  <li>Coffee: {{ coffee_count }} cups</li>
                  <li>Snacks: {{ snacks_count }} items</li>
                  <li>Breakfast: {{ breakfast_count }} plates</li>
                  <li>Lunch: {{ lunch_count }} plates</li>
                  <li>Dinner: {{ dinner_count }} plates</li>
                </ul>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card p-4" style="height: 300px;">
                <h5>Monthly Report</h5>
                <canvas id="monthlyChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Admin Panel + User History -->
          <div class="row mb-4">
            <!-- Admin Panel -->
            <div class="col-md-6">
              <div class="card p-4">
                <h5>Admin Panel</h5>
                <ul class="list-unstyled">
                  <li>
                    <a href="{% url 'qr:view_reports' %}" style="color:#0000EE; text-decoration: underline;">
                        üìä View & Download Reports
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'qr:manage_menu_items' %}" style="color:#0000EE; text-decoration: underline;">
                        üìã Manage Menu Items
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'qr:time_slots' %}" style="color:#0000EE; text-decoration: underline;">
                        ‚è∞ Time-based Meal Slot Settings
                    </a>
                  </li>
                </ul>
              </div>
            </div>

            <!-- User History -->
            <div class="col-md-6">
              <div class="card shadow-sm rounded-3 h-100">
                <div class="card p-4" style="height: 160px; overflow-y: auto;">
                  <h5>User History (Last 5)</h5>
                  <div class="card-body">
                    {% if latest_meals %}
                      <table class="table table-striped table-bordered mb-0">
                        <thead>
                          <tr>
                            <th>User</th>
                            <th>Meal</th>
                            <th>Qty</th>
                            <th>Date</th>
                            <th>Time</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for meal in latest_meals %}
                          <tr>
                            <td>{{ meal.name_id }}</td>
                            <td>{{ meal.meal }}</td>
                            <td>{{ meal.quantity }}</td>
                            <td>{{ meal.date }}</td>
                            <td>{{ meal.time }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% else %}
                      <p class="text-muted">No recent history available.</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- üìã Manage Menu Items box -->
          <div id="manage-menu-items-box" style="display:none; margin-top: 20px;">
            <h4>Manage Menu Items</h4>
            <div id="menu-items-container">
              <!-- JS will populate items -->
            </div>
          </div>

          <!-- ‚úèÔ∏è Edit Form -->
          <div id="edit-form-container" style="display:none; margin-top:20px;">
            <h5>‚úèÔ∏è Edit Item</h5>
            <form id="edit-form" onsubmit="submitEditForm(event)">
              <input type="hidden" id="edit-item-id" />
              <div class="mb-3">
                <label>Item Name</label>
                <input type="text" class="form-control" id="edit-item-name" required />
              </div>
              <div class="mb-3">
                <label>Price (‚Çπ)</label>
                <input type="number" class="form-control" id="edit-item-price" step="0.01" required />
              </div>
              <button type="submit" class="btn btn-success">üíæ Update Item</button>
            </form>
          </div>

          <!-- üïí Meal Slot Timings -->
          <h4 class="mb-3">Meal Slot Timings</h4>
          {% if slots %}
            <div class="row">
              {% for slot in slots %}
              <div class="col-md-4 mb-4">
                <div class="card p-3 text-center">
                  <h5 class="card-title">{{ slot.meal_type|title }}</h5>
                  <p class="time">{{ slot.start_time }} - {{ slot.end_time }}</p>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-warning">No meal slots defined.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{% static 'js/dashboard.js' %}"></script>

  <script>
    // ----- Sidebar submenu toggle -----
    function toggleSubMenu(id) {
      const submenu = document.getElementById(id);
      submenu.style.display = (submenu.style.display === "block") ? "none" : "block";
    }

    // ----- Manage Menu Items -----
    function showManageMenuItems() {
      const box = document.getElementById('manage-menu-items-box');
      if (box.style.display === 'none' || box.style.display === '') {
        box.style.display = 'block';
        fetchMenuItems();
      } else {
        box.style.display = 'none';
        hideEditForm();
      }
    }

    function fetchMenuItems() {
      fetch("{% url 'qr:api_get_menu_items' %}")
        .then(response => response.json())
        .then(data => {
          const container = document.getElementById('menu-items-container');
          container.innerHTML = '';
          data.menu_items.forEach(item => {
            const div = document.createElement('div');
            div.classList.add('menu-card');
            div.innerHTML = `
              <h5>${item.name}</h5>
              <p>Price: ‚Çπ${item.price}</p>
              <button class="btn btn-sm btn-primary" onclick="editItem(${item.id}, '${item.name}', '${item.price}')">‚úèÔ∏è Edit</button>
            `;
            container.appendChild(div);
          });
        });
    }

    function editItem(id, name, price) {
      document.getElementById('edit-form-container').style.display = 'block';
      document.getElementById('edit-item-id').value = id;
      document.getElementById('edit-item-name').value = name;
      document.getElementById('edit-item-price').value = price;
    }

    function hideEditForm() {
      document.getElementById('edit-form-container').style.display = 'none';
    }

    function submitEditForm(event) {
      event.preventDefault();
      const id = document.getElementById('edit-item-id').value;
      const name = document.getElementById('edit-item-name').value;
      const price = document.getElementById('edit-item-price').value;
      fetch("{% url 'qr:save_item' %}", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ id, name, price })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        fetchMenuItems();
        hideEditForm();
      });
    }

    // ----- Chart.js instance -----
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    let monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [], // last 5 dates
            datasets: [
                { label: 'Tea', backgroundColor: 'rgba(255, 99, 132, 0.6)', data: [], barThickness: 20 },
                { label: 'Snacks', backgroundColor: 'rgba(54, 162, 235, 0.6)', data: [], barThickness: 20 },
                { label: 'Coffee', backgroundColor: 'rgba(255, 206, 86, 0.6)', data: [], barThickness: 20 },
                { label: 'Breakfast', backgroundColor: 'rgba(75, 192, 192, 0.6)', data: [], barThickness: 20 },
                { label: 'Lunch', backgroundColor: 'rgba(153, 102, 255, 0.6)', data: [], barThickness: 20 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    async function updateChart() {
        const res = await fetch("{% url 'qr:api_chart_last_5_days' %}");
        const data = await res.json();

        monthlyChart.data.labels = data.labels;
        monthlyChart.data.datasets[0].data = data.tea;
        monthlyChart.data.datasets[1].data = data.snack;
        monthlyChart.data.datasets[2].data = data.coffee;
        monthlyChart.data.datasets[3].data = data.breakfast;
        monthlyChart.data.datasets[4].data = data.lunch;

        monthlyChart.update();
    }

    // Call initially and auto-refresh every 5 seconds
    updateChart();
    setInterval(updateChart, 5000);

    // ----- QR scan callback -----
    function onQRScanSuccess(qrData) {
      fetch("{% url 'qr:save_qr_data' %}", {
          method: "POST",
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify(qrData)
      })
      .then(res => res.json())
      .then(data => {
          if (data.status === "success") {
              updateChart(); // refresh chart immediately
          }
      });
    }
  </script>
</body>
</html>
